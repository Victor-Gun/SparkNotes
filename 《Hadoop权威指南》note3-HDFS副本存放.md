#《Hadoop权威指南》note3-HDFS副本存放
_整理：leotse_

### 引子
我们都知道，为了保证HDFS的高可用性，我们常常将数据块存储多份（默认存储3份）。那么，这些副本在HDFS中是怎么存储的呢？

### 简单粗暴的解决方案
最容易想到的策略是随机选取3个（我们以默认的存储3个副本作为示例）datanode进行存储。这种方法最简单粗暴，实现起来也最简单，但是这种方案存在诸多弊端：  
1.datanode的负载，如果完全随机选取datanode进行存储，那么很有可能造成有些datanode负载比其他datanode大，负载更大的机器发生宕机的可能性更大；  
2.不能保证高可用性，如果选取的3个datanode正好在同一个机架上，当该机架出现事故，所有副本变得可用，这就丧失了保存多份副本的初衷；还有我们采取多副本保存数据块也是为了降低某一个节点或者机架的读取带宽，亦即当多个client对于某一数据块进行访问时，多副本可以一定程度上减少单副本情况下的读取带宽瓶颈，如果在同一机架上，带宽占用就和单副本没有区别；  
3.我们考虑另一个极端情况，我们这3个数据块恰好分布在三个机架或者三个数据中心，这样确实可以最大限度地提高副本的冗余程度，保证了高可用性，但是我们还需要考虑另一个很重要的问题：写入带宽。跨数据中心对带宽的消耗特别大，而我们知道，带宽是非常珍贵的资源。

### Hadoop提供的解决方案
我们可以总结出，我们考虑副本存放策略时，需要把三个因素放在心里：**可靠性**、**写入带宽**以及**读取带宽**。

Hadoop的默认布局策略是这样的，如果client在集群中，那么就在client所在的节点上放第一个副本，如果client在集群之外，就随机选择一个节点，当然，考虑到负载平衡，系统不会随机挑选那些负载很高的节点。第二个副本放在**与第一个副本不同且随机**的另一个机架的节点上，第三个副本与第二个副本放在同一个机架上，且随机选择另一个节点。如果副本数大于3，那么其他副本放在集群中随机选择的节点上，不过系统会尽量避免在同一个机架放太多副本。

总结来说，这种方案不仅保证了数据的可靠性，同时也在写入带宽和读取带宽上做了比较好的平衡，并实现了很好的负载平衡，同时，client只在本地机架上写入一个数据块也保证了集群中块的均匀分布。